name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly tests at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/4, 2/4, 3/4, 4/4]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Setup test database
        run: |
          docker run -d \
            --name postgres-test \
            -e POSTGRES_DB=oneclicktag_test \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=testpass \
            -p 5433:5432 \
            postgres:15
          
          # Wait for database to be ready
          sleep 10

      - name: Run database migrations
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test:testpass@localhost:5433/oneclicktag_test
        run: npm run db:migrate

      - name: Seed test data
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test:testpass@localhost:5433/oneclicktag_test
        run: npm run db:seed:test

      - name: Start backend server
        working-directory: ./backend
        env:
          NODE_ENV: test
          PORT: 3001
          DATABASE_URL: postgresql://test:testpass@localhost:5433/oneclicktag_test
          JWT_SECRET: test-jwt-secret
          GOOGLE_GTM_CLIENT_ID: test-gtm-client-id
          GOOGLE_GTM_CLIENT_SECRET: test-gtm-client-secret
        run: |
          npm run build
          npm run start &
          
          # Wait for server to start
          npx wait-on http://localhost:3001/health --timeout 60000

      - name: Build frontend
        working-directory: ./frontend
        env:
          NODE_ENV: test
          VITE_API_BASE_URL: http://localhost:3001/api
        run: npm run build

      - name: Start frontend server
        working-directory: ./frontend
        run: |
          npm run preview &
          
          # Wait for frontend to start
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Playwright tests
        working-directory: ./frontend
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
        run: |
          npx playwright test \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }} \
            --reporter=html,junit \
            --output-dir=test-results/playwright \
            --timeout=60000

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.browser }}-${{ strategy.job-index }}
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 7

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}-${{ strategy.job-index }}
          path: frontend/e2e/screenshots/
          retention-days: 7

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Playwright Tests (${{ matrix.browser }})
          path: frontend/test-results/junit.xml
          reporter: java-junit

      - name: Cleanup
        if: always()
        run: |
          docker stop postgres-test || true
          docker rm postgres-test || true

  visual-regression:
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install chromium

      - name: Setup test environment
        run: |
          # Setup database and backend (same as above)
          docker run -d \
            --name postgres-visual \
            -e POSTGRES_DB=oneclicktag_test \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=testpass \
            -p 5434:5432 \
            postgres:15
          
          sleep 10

      - name: Start services
        run: |
          # Start backend and frontend (same as above)
          cd backend && npm ci && npm run build && npm run start &
          cd frontend && npm run build && npm run preview &
          
          npx wait-on http://localhost:3001/health http://localhost:3000 --timeout 120000

      - name: Download baseline screenshots
        run: |
          # Download baseline screenshots from the main branch or artifact storage
          mkdir -p frontend/e2e/screenshots/baseline
          # This would typically download from a storage service or previous builds

      - name: Run visual regression tests
        working-directory: ./frontend
        run: |
          npx playwright test \
            --project=visual-regression \
            --reporter=html \
            --timeout=60000

      - name: Upload visual comparison results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-results
          path: |
            frontend/e2e/screenshots/
            frontend/e2e/visual-report.html
          retention-days: 30

      - name: Comment on PR with visual changes
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const reportPath = path.join(process.cwd(), 'frontend/e2e/visual-report.html');
            
            if (fs.existsSync(reportPath)) {
              const comment = `
              ## ðŸ“¸ Visual Regression Test Results
              
              Visual differences detected in this PR. Please review the changes:
              
              [View detailed visual comparison report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              If these changes are intentional, update the baseline images by running:
              \`\`\`bash
              npm run e2e:update-baselines
              \`\`\`
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  performance-tests:
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install chromium

      - name: Setup test environment
        run: |
          # Same setup as previous jobs
          docker run -d \
            --name postgres-perf \
            -e POSTGRES_DB=oneclicktag_test \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=testpass \
            -p 5435:5432 \
            postgres:15

      - name: Start services with production build
        run: |
          # Build and start services
          cd backend && npm ci && npm run build && npm run start &
          cd frontend && npm run build && npm run preview &
          
          npx wait-on http://localhost:3001/health http://localhost:3000 --timeout 120000

      - name: Run Lighthouse performance tests
        working-directory: ./frontend
        run: |
          npx playwright test \
            --project=chromium \
            --grep="performance" \
            --reporter=html

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            frontend/lighthouse-reports/
            frontend/performance-metrics.json
          retention-days: 30

  deploy-preview:
    runs-on: ubuntu-latest
    needs: [e2e-tests, visual-regression]
    if: github.event_name == 'pull_request' && success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to preview environment
        run: |
          echo "Deploying to preview environment..."
          # This would typically deploy to a staging/preview environment
          # for manual testing and review

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ðŸš€ Preview Deployment
            
            Your changes have been deployed to a preview environment:
            
            ðŸ”— **Preview URL**: https://pr-${{ github.event.number }}-oneclicktag-preview.netlify.app
            
            This deployment will be automatically cleaned up when the PR is closed.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-results:
    runs-on: ubuntu-latest
    needs: [e2e-tests, visual-regression, performance-tests]
    if: always()
    
    steps:
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#dev-alerts'
          text: |
            ðŸš¨ E2E Tests Failed
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Check the failed tests: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}