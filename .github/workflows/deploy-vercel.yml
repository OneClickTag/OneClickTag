name: Deploy to Vercel

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'shared/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-vercel.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - preview

concurrency:
  group: vercel-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      commit-sha: ${{ steps.check.outputs.commit-sha }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if deployment needed
        id: check
        run: |
          # Check if this is a deployment commit or if frontend/shared files changed
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif git diff --name-only HEAD^ HEAD | grep -E '^(frontend/|shared/|package\.json|pnpm-lock\.yaml)'; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi
          echo "commit-sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Notify deployment start
        if: steps.check.outputs.should-deploy == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "#deployments",
              "attachments": [{
                "color": "warning",
                "title": "üöÄ Frontend Deployment Started",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "${{ inputs.environment || 'production' }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions",
                "ts": ${{ github.event.head_commit.timestamp }}
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  build-and-test:
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm --filter frontend type-check

      - name: Lint
        run: pnpm --filter frontend lint

      - name: Run tests
        run: pnpm --filter frontend test:run

      - name: Build for production
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL_PROD }}
          VITE_GTM_CONTAINER_ID: ${{ secrets.VITE_GTM_CONTAINER_ID }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_ENVIRONMENT: ${{ inputs.environment || 'production' }}
          VITE_VERSION: ${{ github.sha }}
        run: pnpm --filter frontend build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 1

  lighthouse-audit:
    runs-on: ubuntu-latest
    needs: [pre-deploy, build-and-test]
    if: needs.pre-deploy.outputs.should-deploy == 'true' && github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

      - name: Serve built app
        run: |
          npm install -g serve
          serve -s frontend/dist -p 3000 &
          sleep 5

      - name: Run Lighthouse audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true

  deploy-vercel:
    runs-on: ubuntu-latest
    needs: [pre-deploy, build-and-test]
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment
        run: |
          vercel pull --yes --environment=${{ inputs.environment || 'production' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project artifacts
        run: |
          vercel build --token=${{ secrets.VERCEL_TOKEN }} ${{ inputs.environment != 'production' && '--prod' || '' }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          if [[ "${{ inputs.environment || 'production' }}" == "production" ]]; then
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          else
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          fi
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

      - name: Update deployment status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: '${{ steps.deploy.outputs.deployment-id }}',
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.deployment-url }}',
              description: 'Deployment completed successfully'
            });

      - name: Comment deployment URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üöÄ Deployment Preview
            
            Your changes have been deployed to Vercel:
            
            üîó **Preview URL**: ${{ steps.deploy.outputs.deployment-url }}
            
            ### üìä Lighthouse Scores
            Performance metrics will be available once the Lighthouse audit completes.
            
            ---
            <sub>Deployed commit: ${{ github.sha }}</sub>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: [deploy-vercel]
    if: always() && needs.deploy-vercel.result == 'success'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: pnpm --filter frontend exec playwright install --with-deps chromium

      - name: Run smoke tests against deployed app
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.deploy-vercel.outputs.deployment-url }}
          NODE_ENV: production
        run: |
          pnpm --filter frontend exec playwright test tests/smoke.spec.ts --project=chromium

      - name: Run accessibility tests
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.deploy-vercel.outputs.deployment-url }}
        run: |
          pnpm --filter frontend exec playwright test tests/accessibility.spec.ts --project=chromium

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-test-results
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 7

  update-monitoring:
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-tests]
    if: always() && needs.deploy-vercel.result == 'success'
    
    steps:
      - name: Update Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: oneclicktag-frontend
        with:
          environment: ${{ inputs.environment || 'production' }}
          version: ${{ github.sha }}
          finalize: true

      - name: Update DataDog deployment marker
        run: |
          curl -X POST "https://api.datadoghq.com/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DD_API_KEY }}" \
            -d '{
              "title": "Frontend Deployment",
              "text": "Frontend deployed to ${{ inputs.environment || 'production' }}",
              "date_happened": '$(date +%s)',
              "priority": "normal",
              "alert_type": "info",
              "tags": [
                "service:oneclicktag-frontend",
                "environment:${{ inputs.environment || 'production' }}",
                "version:${{ github.sha }}"
              ]
            }'

  notify-completion:
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-tests, lighthouse-audit, update-monitoring]
    if: always()
    
    steps:
      - name: Notify successful deployment
        if: needs.deploy-vercel.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            ‚úÖ Frontend Deployment Successful
            
            **Environment**: ${{ inputs.environment || 'production' }}
            **URL**: ${{ needs.deploy-vercel.outputs.deployment-url }}
            **Commit**: ${{ github.sha }}
            **Author**: ${{ github.actor }}
            
            **Post-Deploy Tests**: ${{ needs.post-deploy-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
            **Lighthouse Audit**: ${{ needs.lighthouse-audit.result == 'success' && '‚úÖ Completed' || needs.lighthouse-audit.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}
            **Monitoring**: ${{ needs.update-monitoring.result == 'success' && '‚úÖ Updated' || '‚ùå Failed' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify failed deployment
        if: needs.deploy-vercel.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#dev-alerts'
          text: |
            üö® Frontend Deployment Failed
            
            **Environment**: ${{ inputs.environment || 'production' }}
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            **Author**: ${{ github.actor }}
            
            [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback-on-failure:
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-tests]
    if: always() && (needs.deploy-vercel.result == 'failure' || needs.post-deploy-tests.result == 'failure')
    
    steps:
      - name: Rollback deployment
        run: |
          echo "üîÑ Rolling back deployment..."
          # Get previous deployment
          PREVIOUS_DEPLOYMENT=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} | grep -v "$(echo '${{ needs.deploy-vercel.outputs.deployment-url }}' | sed 's/https:\/\///')" | head -1 | awk '{print $2}')
          
          if [ ! -z "$PREVIOUS_DEPLOYMENT" ]; then
            vercel promote $PREVIOUS_DEPLOYMENT --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
            echo "‚úÖ Rollback completed to: $PREVIOUS_DEPLOYMENT"
          else
            echo "‚ö†Ô∏è No previous deployment found for rollback"
          fi

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "#dev-alerts",
              "attachments": [{
                "color": "warning",
                "title": "üîÑ Deployment Rolled Back",
                "text": "Frontend deployment was automatically rolled back due to failures.",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "${{ inputs.environment || 'production' }}",
                    "short": true
                  },
                  {
                    "title": "Failed Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}