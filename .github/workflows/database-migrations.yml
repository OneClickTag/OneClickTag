name: Database Migrations

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/prisma/migrations/**'
      - 'backend/prisma/schema.prisma'
      - 'backend/prisma/seed.ts'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/prisma/migrations/**'
      - 'backend/prisma/schema.prisma'
      - 'backend/prisma/seed.ts'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations on'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production
      operation:
        description: 'Operation to perform'
        required: true
        default: 'migrate'
        type: choice
        options:
        - migrate
        - rollback
        - reset
        - seed
      dry_run:
        description: 'Perform dry run (preview only)'
        required: false
        default: false
        type: boolean

concurrency:
  group: database-migrations-${{ inputs.environment || github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pnpm install --frozen-lockfile

      - name: Validate Prisma schema
        run: |
          cd backend
          pnpm prisma validate

      - name: Check for schema drift
        run: |
          cd backend
          pnpm prisma format --check

      - name: Generate Prisma client
        run: |
          cd backend
          pnpm prisma generate

      - name: Check migration files
        run: |
          cd backend
          # Check if migration files are properly formatted
          find prisma/migrations -name "*.sql" -exec sqlfluff lint {} \; || true

  test-migrations:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: migration_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pnpm install --frozen-lockfile

      - name: Test migration on clean database
        env:
          DATABASE_URL: postgresql://test:testpass@localhost:5432/migration_test
        run: |
          cd backend
          
          # Reset database to clean state
          pnpm prisma migrate reset --force --skip-seed
          
          # Apply all migrations
          pnpm prisma migrate deploy
          
          # Verify database state
          pnpm prisma db pull --print > /tmp/db_schema.prisma
          diff <(pnpm prisma format --schema=prisma/schema.prisma --stdout) <(pnpm prisma format --schema=/tmp/db_schema.prisma --stdout)

      - name: Test rollback capability
        env:
          DATABASE_URL: postgresql://test:testpass@localhost:5432/migration_test
        run: |
          cd backend
          
          # Get current migration count
          CURRENT_MIGRATIONS=$(ls -1 prisma/migrations | wc -l)
          
          if [ $CURRENT_MIGRATIONS -gt 1 ]; then
            # Get the latest migration directory
            LATEST_MIGRATION=$(ls -1 prisma/migrations | tail -n 1)
            
            # Create a backup of the latest migration
            cp -r "prisma/migrations/$LATEST_MIGRATION" "/tmp/$LATEST_MIGRATION.bak"
            
            # Remove the latest migration temporarily
            rm -rf "prisma/migrations/$LATEST_MIGRATION"
            
            # Reset and apply migrations without the latest one
            pnpm prisma migrate reset --force --skip-seed
            pnpm prisma migrate deploy
            
            # Restore the migration
            cp -r "/tmp/$LATEST_MIGRATION.bak" "prisma/migrations/$LATEST_MIGRATION"
            
            # Apply the restored migration
            pnpm prisma migrate deploy
            
            echo "âœ… Migration rollback test passed"
          else
            echo "âš ï¸ Only one migration found, skipping rollback test"
          fi

      - name: Test seed data
        env:
          DATABASE_URL: postgresql://test:testpass@localhost:5432/migration_test
        run: |
          cd backend
          
          # Run seed script
          pnpm prisma db seed
          
          # Verify seed data was inserted
          pnpm prisma studio --browser=none &
          STUDIO_PID=$!
          sleep 5
          kill $STUDIO_PID

  backup-database:
    runs-on: ubuntu-latest
    needs: [validate-schema, test-migrations]
    if: always() && (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main')
    environment: ${{ inputs.environment || 'staging' }}
    
    steps:
      - name: Create database backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="${{ inputs.environment || 'staging' }}_backup_${TIMESTAMP}"
          
          # Create backup using pg_dump
          PGPASSWORD="${{ secrets.DATABASE_PASSWORD }}" pg_dump \
            -h ${{ secrets.DATABASE_HOST }} \
            -p ${{ secrets.DATABASE_PORT }} \
            -U ${{ secrets.DATABASE_USER }} \
            -d ${{ secrets.DATABASE_NAME }} \
            --no-password \
            --verbose \
            --format=custom \
            --file="${BACKUP_NAME}.dump"
          
          # Compress backup
          gzip "${BACKUP_NAME}.dump"
          
          echo "BACKUP_FILE=${BACKUP_NAME}.dump.gz" >> $GITHUB_ENV

      - name: Upload backup to S3
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Store backup in S3
        run: |
          aws s3 cp "${BACKUP_FILE}" s3://${{ secrets.BACKUP_S3_BUCKET }}/database-backups/${{ inputs.environment || 'staging' }}/${BACKUP_FILE}
          
          # Set lifecycle policy to delete backups older than 30 days
          aws s3api put-object-tagging \
            --bucket ${{ secrets.BACKUP_S3_BUCKET }} \
            --key "database-backups/${{ inputs.environment || 'staging' }}/${BACKUP_FILE}" \
            --tagging 'TagSet=[{Key=RetentionDays,Value=30}]'

      - name: Notify backup completion
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#database-ops'
          text: |
            ðŸ“¦ Database Backup Created
            
            **Environment**: ${{ inputs.environment || 'staging' }}
            **Backup File**: ${BACKUP_FILE}
            **Location**: s3://${{ secrets.BACKUP_S3_BUCKET }}/database-backups/${{ inputs.environment || 'staging' }}/
            **Triggered by**: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  run-migrations:
    runs-on: ubuntu-latest
    needs: [backup-database]
    if: always() && needs.backup-database.result == 'success'
    environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pnpm install --frozen-lockfile

      - name: Check database connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          pnpm prisma db pull --print > /dev/null
          echo "âœ… Database connection verified"

      - name: Preview migrations (dry run)
        if: inputs.dry_run == true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          echo "ðŸ” Migration Preview (Dry Run)"
          echo "=============================="
          
          # Show pending migrations
          pnpm prisma migrate status
          
          echo ""
          echo "ðŸ“‹ Migration Plan:"
          echo "=================="
          
          # Generate migration diff
          pnpm prisma migrate diff \
            --from-migrations prisma/migrations \
            --to-schema-datamodel prisma/schema.prisma \
            --shadow-database-url ${{ secrets.SHADOW_DATABASE_URL }} \
            --script > migration_preview.sql
          
          if [ -s migration_preview.sql ]; then
            echo "SQL to be executed:"
            cat migration_preview.sql
          else
            echo "No pending migrations found."
          fi

      - name: Run database migrations
        if: inputs.dry_run != true && (inputs.operation == 'migrate' || inputs.operation == '')
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          echo "ðŸš€ Running database migrations..."
          
          # Deploy migrations
          pnpm prisma migrate deploy
          
          # Verify migration status
          pnpm prisma migrate status
          
          echo "âœ… Migrations completed successfully"

      - name: Rollback migrations
        if: inputs.dry_run != true && inputs.operation == 'rollback'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          echo "ðŸ”„ Rolling back migrations..."
          
          # Get the latest migration
          LATEST_MIGRATION=$(ls -1 prisma/migrations | tail -n 1)
          
          if [ ! -z "$LATEST_MIGRATION" ]; then
            # Create rollback SQL
            echo "Rolling back migration: $LATEST_MIGRATION"
            
            # Move the migration folder to a backup location
            mv "prisma/migrations/$LATEST_MIGRATION" "prisma/migrations/.${LATEST_MIGRATION}.rollback"
            
            # Reset database to the previous migration state
            pnpm prisma migrate reset --force --skip-seed
            pnpm prisma migrate deploy
            
            echo "âœ… Rollback completed for migration: $LATEST_MIGRATION"
          else
            echo "âŒ No migrations found to rollback"
            exit 1
          fi

      - name: Reset database
        if: inputs.dry_run != true && inputs.operation == 'reset'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          echo "ðŸ”„ Resetting database..."
          echo "âš ï¸  WARNING: This will delete all data!"
          
          # Reset database
          pnpm prisma migrate reset --force --skip-seed
          
          # Apply all migrations
          pnpm prisma migrate deploy
          
          echo "âœ… Database reset completed"

      - name: Seed database
        if: inputs.dry_run != true && (inputs.operation == 'seed' || inputs.operation == 'reset')
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ inputs.environment || 'staging' }}
        run: |
          cd backend
          
          echo "ðŸŒ± Seeding database..."
          
          # Run seed script
          pnpm prisma db seed
          
          echo "âœ… Database seeding completed"

      - name: Update database schema documentation
        if: inputs.dry_run != true && (inputs.operation == 'migrate' || inputs.operation == '')
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          # Generate ERD (Entity Relationship Diagram)
          pnpm prisma generate
          
          # Create schema documentation
          pnpm prisma-docs generate --output ../docs/database-schema.md
          
          # Commit documentation updates if in main branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add ../docs/database-schema.md
            git diff --staged --quiet || git commit -m "docs: update database schema documentation [skip ci]"
            git push
          fi

  verify-deployment:
    runs-on: ubuntu-latest
    needs: [run-migrations]
    if: always() && needs.run-migrations.result == 'success' && inputs.dry_run != true
    environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pnpm install --frozen-lockfile

      - name: Verify database integrity
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          echo "ðŸ” Verifying database integrity..."
          
          # Check migration status
          pnpm prisma migrate status
          
          # Validate schema against database
          pnpm prisma db pull --print > /tmp/actual_schema.prisma
          pnpm prisma format --schema=/tmp/actual_schema.prisma
          
          # Compare schemas
          if ! diff <(pnpm prisma format --schema=prisma/schema.prisma --stdout) <(pnpm prisma format --schema=/tmp/actual_schema.prisma --stdout); then
            echo "âŒ Database schema doesn't match Prisma schema"
            exit 1
          fi
          
          echo "âœ… Database integrity verification passed"

      - name: Run database health checks
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          
          echo "ðŸ¥ Running database health checks..."
          
          # Check if we can connect and run basic queries
          node -e "
            const { PrismaClient } = require('@prisma/client');
            const prisma = new PrismaClient();
            
            async function healthCheck() {
              try {
                // Test connection
                await prisma.\$queryRaw\`SELECT 1\`;
                
                // Test basic operations on key tables
                const userCount = await prisma.user.count();
                const tenantCount = await prisma.tenant.count();
                
                console.log(\`âœ… Database health check passed\`);
                console.log(\`   Users: \${userCount}\`);
                console.log(\`   Tenants: \${tenantCount}\`);
                
                await prisma.\$disconnect();
              } catch (error) {
                console.error('âŒ Database health check failed:', error);
                process.exit(1);
              }
            }
            
            healthCheck();
          "

  notify-completion:
    runs-on: ubuntu-latest
    needs: [validate-schema, test-migrations, backup-database, run-migrations, verify-deployment]
    if: always()
    
    steps:
      - name: Notify success
        if: needs.run-migrations.result == 'success' && needs.verify-deployment.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#database-ops'
          text: |
            âœ… Database Migration Completed Successfully
            
            **Environment**: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
            **Operation**: ${{ inputs.operation || 'migrate' }}
            **Triggered by**: ${{ github.actor }}
            **Commit**: ${{ github.sha }}
            
            **Results**:
            - Backup: ${{ needs.backup-database.result == 'success' && 'âœ…' || 'âŒ' }}
            - Migration: ${{ needs.run-migrations.result == 'success' && 'âœ…' || 'âŒ' }}
            - Verification: ${{ needs.verify-deployment.result == 'success' && 'âœ…' || 'âŒ' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify failure
        if: contains(needs.*.result, 'failure')
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#dev-alerts'
          text: |
            ðŸš¨ Database Migration Failed
            
            **Environment**: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
            **Operation**: ${{ inputs.operation || 'migrate' }}
            **Triggered by**: ${{ github.actor }}
            
            **Failed Steps**:
            ${{ needs.validate-schema.result == 'failure' && '- Schema Validation' || '' }}
            ${{ needs.test-migrations.result == 'failure' && '- Migration Tests' || '' }}
            ${{ needs.backup-database.result == 'failure' && '- Database Backup' || '' }}
            ${{ needs.run-migrations.result == 'failure' && '- Migration Execution' || '' }}
            ${{ needs.verify-deployment.result == 'failure' && '- Deployment Verification' || '' }}
            
            [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ðŸ”„ **Recovery**: Database backup is available for rollback if needed.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  emergency-rollback:
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch' && inputs.environment == 'production'
    environment: production
    
    steps:
      - name: Emergency rollback procedure
        run: |
          echo "ðŸš¨ EMERGENCY ROLLBACK INITIATED"
          echo "==============================="
          
          # Find latest backup
          LATEST_BACKUP=$(aws s3 ls s3://${{ secrets.BACKUP_S3_BUCKET }}/database-backups/production/ --recursive | sort | tail -n 1 | awk '{print $4}')
          
          if [ ! -z "$LATEST_BACKUP" ]; then
            echo "ðŸ“¦ Latest backup found: $LATEST_BACKUP"
            
            # Download backup
            aws s3 cp "s3://${{ secrets.BACKUP_S3_BUCKET }}/$LATEST_BACKUP" ./latest_backup.dump.gz
            gunzip latest_backup.dump.gz
            
            # Restore database
            PGPASSWORD="${{ secrets.DATABASE_PASSWORD }}" pg_restore \
              -h ${{ secrets.DATABASE_HOST }} \
              -p ${{ secrets.DATABASE_PORT }} \
              -U ${{ secrets.DATABASE_USER }} \
              -d ${{ secrets.DATABASE_NAME }} \
              --clean \
              --if-exists \
              --verbose \
              latest_backup.dump
            
            echo "âœ… Emergency rollback completed"
          else
            echo "âŒ No backup found for rollback"
            exit 1
          fi

      - name: Notify emergency rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "#critical-alerts",
              "attachments": [{
                "color": "danger",
                "title": "ðŸš¨ EMERGENCY DATABASE ROLLBACK EXECUTED",
                "text": "Production database has been rolled back due to migration failure.",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "Production",
                    "short": true
                  },
                  {
                    "title": "Triggered by",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ],
                "footer": "Immediate investigation required"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CRITICAL_WEBHOOK_URL }}