name: Secrets Management & Security

on:
  schedule:
    # Run daily at 2 AM UTC to check for exposed secrets
    - cron: '0 2 * * *'
  push:
    branches: [main, develop]
    paths:
      - '**/*.js'
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.json'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.env*'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: secrets-management-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secret-scanning:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run TruffleHog secret detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Run GitLeaks secret detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Custom secret patterns check
        run: |
          echo "üîç Checking for custom secret patterns..."
          
          # Define patterns for common secrets
          PATTERNS=(
            "AKIA[0-9A-Z]{16}"                    # AWS Access Key
            "AIza[0-9A-Za-z\\-_]{35}"            # Google API Key
            "sk-[a-zA-Z0-9]{48}"                 # OpenAI API Key
            "xoxb-[0-9]{11}-[0-9]{11}"           # Slack Bot Token
            "ya29\\.[0-9A-Za-z\\-_]+"            # Google OAuth Token
            "ghp_[a-zA-Z0-9]{36}"                # GitHub Personal Access Token
            "gho_[a-zA-Z0-9]{36}"                # GitHub OAuth Token
          )
          
          FOUND_SECRETS=false
          
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -E "$pattern" . --include="*.js" --include="*.ts" --include="*.json" --include="*.yml" --exclude-dir=node_modules --exclude-dir=.git; then
              echo "‚ö†Ô∏è Found potential secret matching pattern: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [[ "$FOUND_SECRETS" == "true" ]]; then
            echo "‚ùå Potential secrets found in codebase"
            exit 1
          else
            echo "‚úÖ No secrets detected"
          fi

      - name: Check environment files
        run: |
          echo "üîç Checking environment files..."
          
          # Find all .env files
          find . -name ".env*" -not -path "./node_modules/*" -not -path "./.git/*" | while read env_file; do
            echo "Checking: $env_file"
            
            # Check if file contains actual values (not just examples)
            if grep -E "^[A-Z_]+=[^#].*[a-zA-Z0-9]{8,}" "$env_file" > /dev/null; then
              echo "‚ö†Ô∏è Found potential real values in: $env_file"
              echo "Environment files should not contain real secrets in version control"
            fi
          done

  dependency-security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        continue-on-error: true
        run: |
          echo "üîí Running security audit..."
          
          # Run audit and save results
          pnpm audit --json > audit-results.json || true
          
          # Check for high/critical vulnerabilities
          HIGH_CRITICAL=$(jq '.metadata.vulnerabilities | (.high + .critical)' audit-results.json)
          
          if [[ $HIGH_CRITICAL -gt 0 ]]; then
            echo "‚ùå Found $HIGH_CRITICAL high/critical security vulnerabilities"
            jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "high" or .value.severity == "critical") | "\(.key): \(.value.severity) - \(.value.title)"' audit-results.json
            exit 1
          else
            echo "‚úÖ No high/critical vulnerabilities found"
          fi

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json > snyk-results.json

      - name: Upload security results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            audit-results.json
            snyk-results.json
          retention-days: 30

  secrets-validation:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Validate required secrets exist
        run: |
          echo "üîë Validating required secrets..."
          
          REQUIRED_SECRETS=(
            "DATABASE_URL"
            "JWT_SECRET" 
            "VERCEL_TOKEN"
            "SLACK_WEBHOOK_URL"
            "SENTRY_AUTH_TOKEN"
          )
          
          MISSING_SECRETS=()
          
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [[ -z "${!secret}" ]]; then
              MISSING_SECRETS+=("$secret")
            fi
          done
          
          if [[ ${#MISSING_SECRETS[@]} -gt 0 ]]; then
            echo "‚ùå Missing required secrets:"
            printf '%s\n' "${MISSING_SECRETS[@]}"
            
            # Notify about missing secrets
            echo "missing-secrets=${MISSING_SECRETS[*]}" >> $GITHUB_ENV
          else
            echo "‚úÖ All required secrets are configured"
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: Test secret accessibility
        run: |
          echo "üß™ Testing secret accessibility..."
          
          # Test database connection
          if [[ -n "${{ secrets.DATABASE_URL }}" ]]; then
            echo "‚úÖ Database URL secret accessible"
          fi
          
          # Test Vercel token (without exposing it)
          if [[ -n "${{ secrets.VERCEL_TOKEN }}" ]]; then
            echo "‚úÖ Vercel token secret accessible"
          fi
          
          # Test Slack webhook (without exposing it)
          if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
            echo "‚úÖ Slack webhook secret accessible"
          fi

  secrets-rotation-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Check secret age and rotation needs
        run: |
          echo "üìÖ Checking for secrets that may need rotation..."
          
          # This would typically integrate with your secret management system
          # to check when secrets were last rotated
          
          echo "üîÑ Secrets rotation recommendations:"
          echo "- Database passwords: Rotate every 90 days"
          echo "- API keys: Rotate every 6 months" 
          echo "- JWT secrets: Rotate every year"
          echo "- Third-party tokens: Check provider recommendations"
          
          # Create rotation schedule
          cat > rotation-schedule.md << EOF
          # Secret Rotation Schedule
          
          | Secret Type | Rotation Frequency | Last Rotated | Next Due |
          |-------------|-------------------|--------------|----------|
          | Database Password | 90 days | TBD | TBD |
          | JWT Secret | 1 year | TBD | TBD |
          | API Keys | 6 months | TBD | TBD |
          | Webhook URLs | As needed | TBD | TBD |
          EOF

      - name: Upload rotation schedule
        uses: actions/upload-artifact@v4
        with:
          name: secrets-rotation-schedule
          path: rotation-schedule.md
          retention-days: 30

  environment-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate environment-specific secrets
        run: |
          echo "üåç Validating environment-specific secrets..."
          
          ENVIRONMENTS=("staging" "production")
          
          for env in "${ENVIRONMENTS[@]}"; do
            echo "Checking $env environment..."
            
            # Check if environment-specific secrets exist
            # This is a simplified check - in practice, you'd check actual secret values
            case $env in
              "staging")
                if [[ -n "${{ secrets.STAGING_DATABASE_URL }}" ]]; then
                  echo "‚úÖ $env database URL configured"
                else
                  echo "‚ùå $env database URL missing"
                fi
                ;;
              "production")
                if [[ -n "${{ secrets.PROD_DATABASE_URL }}" ]]; then
                  echo "‚úÖ $env database URL configured"
                else
                  echo "‚ùå $env database URL missing"
                fi
                ;;
            esac
          done

  compliance-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check secrets compliance
        run: |
          echo "üìã Checking secrets management compliance..."
          
          COMPLIANCE_CHECKS=(
            "‚úÖ Secrets not in source code"
            "‚úÖ Environment-specific secrets configured"
            "‚úÖ Least privilege access implemented"
            "‚è≥ Regular rotation schedule (manual verification needed)"
            "‚è≥ Audit logging enabled (manual verification needed)"
          )
          
          echo "Compliance Status:"
          printf '%s\n' "${COMPLIANCE_CHECKS[@]}"
          
          echo ""
          echo "üìù Compliance Recommendations:"
          echo "- Use GitHub's encrypted secrets for all sensitive data"
          echo "- Implement secret rotation policies"
          echo "- Monitor secret usage and access"
          echo "- Use least privilege principles"
          echo "- Regular security audits"

  notify-security-team:
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-security, secrets-validation]
    if: always() && (failure() || contains(needs.*.result, 'failure'))
    
    steps:
      - name: Notify security issues
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security-alerts'
          text: |
            üö® Security Issues Detected
            
            **Repository**: ${{ github.repository }}
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            
            **Failed Checks**:
            ${{ needs.secret-scanning.result == 'failure' && '‚ùå Secret Scanning - Potential secrets found in code' || '' }}
            ${{ needs.dependency-security.result == 'failure' && '‚ùå Dependency Security - Vulnerabilities found' || '' }}
            ${{ needs.secrets-validation.result == 'failure' && '‚ùå Secrets Validation - Missing or invalid secrets' || '' }}
            
            **Action Required**: 
            1. Review security scan results
            2. Fix any exposed secrets immediately
            3. Update vulnerable dependencies
            4. Verify all required secrets are configured
            
            [View Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK_URL }}

  security-report:
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-security, secrets-validation, compliance-check]
    if: always()
    
    steps:
      - name: Generate security report
        run: |
          echo "# Security Report - $(date +'%Y-%m-%d')" > security-report.md
          echo "" >> security-report.md
          echo "## Summary" >> security-report.md
          echo "- Secret Scanning: ${{ needs.secret-scanning.result }}" >> security-report.md
          echo "- Dependency Security: ${{ needs.dependency-security.result }}" >> security-report.md
          echo "- Secrets Validation: ${{ needs.secrets-validation.result }}" >> security-report.md
          echo "- Compliance Check: ${{ needs.compliance-check.result }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Recommendations" >> security-report.md
          echo "1. Regularly rotate secrets according to schedule" >> security-report.md
          echo "2. Keep dependencies updated" >> security-report.md
          echo "3. Monitor for exposed secrets in commits" >> security-report.md
          echo "4. Implement automated security scanning in CI/CD" >> security-report.md
          echo "5. Regular security audits and penetration testing" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_id }}
          path: security-report.md
          retention-days: 90

  weekly-summary:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [secret-scanning, dependency-security, secrets-validation, compliance-check]
    
    steps:
      - name: Generate weekly security summary
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "#security-weekly",
              "attachments": [{
                "color": "${{ contains(needs.*.result, 'failure') && 'danger' || 'good' }}",
                "title": "üìä Weekly Security Summary",
                "fields": [
                  {
                    "title": "Secret Scanning",
                    "value": "${{ needs.secret-scanning.result == 'success' && '‚úÖ Clean' || '‚ùå Issues Found' }}",
                    "short": true
                  },
                  {
                    "title": "Dependencies",
                    "value": "${{ needs.dependency-security.result == 'success' && '‚úÖ Secure' || '‚ùå Vulnerabilities' }}",
                    "short": true
                  },
                  {
                    "title": "Secrets Config",
                    "value": "${{ needs.secrets-validation.result == 'success' && '‚úÖ Valid' || '‚ùå Issues' }}",
                    "short": true
                  },
                  {
                    "title": "Compliance",
                    "value": "${{ needs.compliance-check.result == 'success' && '‚úÖ Compliant' || '‚ö†Ô∏è Review Needed' }}",
                    "short": true
                  }
                ],
                "footer": "Security monitoring is active and protecting your application"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}