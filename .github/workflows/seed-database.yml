name: Seed Database

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to seed'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod

env:
  AWS_REGION: eu-central-1

jobs:
  seed:
    name: Seed Database via ECS Task
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECS cluster and task definition info
        id: ecs-info
        run: |
          CLUSTER="${{ github.event.inputs.environment }}-api-cluster"
          SERVICE="${{ github.event.inputs.environment }}-api-svc"

          echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT
          echo "service=$SERVICE" >> $GITHUB_OUTPUT

          # Get the current task definition family
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster $CLUSTER \
            --services $SERVICE \
            --region $AWS_REGION \
            --query 'services[0].taskDefinition' \
            --output text)

          if [ -z "$TASK_DEF_ARN" ] || [ "$TASK_DEF_ARN" = "None" ]; then
            echo "‚ùå Error: Could not find task definition for service $SERVICE"
            exit 1
          fi

          echo "task_definition=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "‚úÖ Found task definition: $TASK_DEF_ARN"

          # Get network configuration from the service
          SUBNETS=$(aws ecs describe-services \
            --cluster $CLUSTER \
            --services $SERVICE \
            --region $AWS_REGION \
            --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' \
            --output json)

          SECURITY_GROUPS=$(aws ecs describe-services \
            --cluster $CLUSTER \
            --services $SERVICE \
            --region $AWS_REGION \
            --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups' \
            --output json)

          echo "subnets=$SUBNETS" >> $GITHUB_OUTPUT
          echo "security_groups=$SECURITY_GROUPS" >> $GITHUB_OUTPUT

      - name: Create task definition override for seeding
        id: task-override
        run: |
          # Create override JSON to run seed command instead of normal start
          cat > task-override.json <<EOF
          {
            "containerOverrides": [
              {
                "name": "${{ github.event.inputs.environment }}-api-container",
                "command": ["sh", "-c", "cd /app/backend && pnpm prisma db seed"]
              }
            ]
          }
          EOF

          echo "‚úÖ Task override created"
          cat task-override.json

      - name: Run seed task
        run: |
          echo "üå± Running seed task for ${{ github.event.inputs.environment }}..."

          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ steps.ecs-info.outputs.cluster }} \
            --task-definition ${{ steps.ecs-info.outputs.task_definition }} \
            --overrides file://task-override.json \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=${{ steps.ecs-info.outputs.subnets }},securityGroups=${{ steps.ecs-info.outputs.security_groups }},assignPublicIp=ENABLED}" \
            --region $AWS_REGION \
            --query 'tasks[0].taskArn' \
            --output text)

          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "‚ùå Error: Failed to start seed task"
            exit 1
          fi

          echo "‚úÖ Seed task started: $TASK_ARN"
          echo "TASK_ARN=$TASK_ARN" >> $GITHUB_ENV

      - name: Wait for seed task to complete
        run: |
          echo "‚è≥ Waiting for seed task to complete..."

          # Wait for task to finish (max 10 minutes)
          aws ecs wait tasks-stopped \
            --cluster ${{ steps.ecs-info.outputs.cluster }} \
            --tasks ${{ env.TASK_ARN }} \
            --region $AWS_REGION

          echo "‚úÖ Seed task completed"

      - name: Check task exit code
        run: |
          echo "üîç Checking task exit code..."

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ steps.ecs-info.outputs.cluster }} \
            --tasks ${{ env.TASK_ARN }} \
            --region $AWS_REGION \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          echo "Exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" != "0" ]; then
            echo "‚ùå Seed task failed with exit code: $EXIT_CODE"
            echo ""
            echo "üìã Check CloudWatch logs for details:"
            echo "https://console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups/log-group/\$252Fecs\$252F${{ github.event.inputs.environment }}-api"
            exit 1
          fi

          echo "‚úÖ Seed task succeeded!"

      - name: Seed summary
        if: success()
        run: |
          echo "‚úÖ Database seeded successfully for ${{ github.event.inputs.environment }}!"
          echo ""
          echo "üìã Seeds include:"
          echo "   - Admin user (admin@oneclicktag.com)"
          echo "   - Content pages (About, Terms, Privacy)"
          echo "   - Pricing plans (Starter, Pro, Enterprise)"
          echo "   - Landing page content (Hero, Features, CTA)"
          echo "   - Site settings (Branding, Colors, Meta)"
          echo "   - Contact page content"

      - name: Seed failed
        if: failure()
        run: |
          echo "‚ùå Database seeding failed for ${{ github.event.inputs.environment }}"
          echo "Check the logs above for error details"
          exit 1
