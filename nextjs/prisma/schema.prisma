// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  password    String?
  firebaseId  String?   @unique
  role        UserRole  @default(USER)
  tenantId    String?
  planId      String?
  planEndDate DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant?      @relation(fields: [tenantId], references: [id])
  plan        Plan?        @relation(fields: [planId], references: [id])
  oauthTokens OAuthToken[]
  customers   Customer[]

  // Compliance relations
  cookieConsents       UserCookieConsent[]
  dataAccessRequests   DataAccessRequest[]
  assignedDataRequests DataAccessRequest[] @relation("AssignedRequests")
  apiAuditLogs         ApiAuditLog[]

  @@index([planId])
  @@map("users")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  domain    String   @unique
  settings  Json?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // OneClickTag-managed Google infrastructure (tenant-level)
  octGtmAccountId   String? // GTM account used for OCT container
  octGtmContainerId String? // OneClickTag container ID
  octGtmPublicId    String? // GTM-XXXXXX (for snippet)
  octGa4AccountId   String? // Analytics account used for OCT property
  octGa4PropertyId  String? // OneClickTag GA4 property ID

  users       User[]
  oauthTokens OAuthToken[]
  customers   Customer[]

  // Compliance relations
  complianceSettings    ComplianceSettings?
  cookieCategories      CookieCategory[]
  cookies               Cookie[]
  cookieConsentBanner   CookieConsentBanner?
  userCookieConsents    UserCookieConsent[]
  dataAccessRequests    DataAccessRequest[]
  apiAuditLogs          ApiAuditLog[]
  subProcessors         SubProcessor[]
  privacyPolicySections PrivacyPolicySection[]

  @@map("tenants")
}

model OAuthToken {
  id           String    @id @default(cuid())
  provider     String // 'google'
  scope        String // 'gtm', 'ads', etc.
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  userId       String
  tenantId     String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, scope])
  @@map("oauth_tokens")
}

model Customer {
  id           String         @id @default(cuid())
  slug         String         @unique
  email        String
  firstName    String
  lastName     String
  fullName     String
  company      String?
  phone        String?
  status       CustomerStatus @default(ACTIVE)
  tags         String[]
  notes        String?
  customFields Json?

  // Tracking Settings
  trackingSettings Json? // {defaultDestinations: ['GA4', 'GOOGLE_ADS'], defaultGA4Property: 'xxx', defaultAdsAccount: 'yyy'}

  // Website
  websiteUrl String?

  // Google Account Connection
  googleAccountId      String?
  googleEmail          String?
  gtmAccountId         String?
  gtmContainerId       String?
  gtmWorkspaceId       String?
  gtmContainerName     String?
  selectedAdsAccountId String? // User-chosen Ads account for this customer
  googleAdsAccounts    GoogleAdsAccount[]
  ga4Properties     GA4Property[]
  campaigns         Campaign[]
  conversionActions ConversionAction[]
  trackings         Tracking[]
  siteScans         SiteScan[]
  siteCredentials   SiteCredential[]

  // Server-Side Tracking (Stape)
  serverSideEnabled Boolean         @default(false)
  stapeContainer    StapeContainer?

  // Health check
  lastHealthCheckAt DateTime?
  healthStatus      String?     @default("unchecked") // "healthy" | "issues_found" | "unchecked"

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // User ownership
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Compliance relations
  apiAuditLogs ApiAuditLog[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([email, tenantId])
  @@index([tenantId, status])
  @@index([tenantId, email])
  @@index([tenantId, firstName, lastName])
  @@index([tenantId, company])
  @@index([userId])
  @@index([userId, tenantId])
  @@map("customers")
}

model StapeContainer {
  id                   String               @id @default(cuid())
  customerId           String               @unique
  customer             Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  stapeContainerId     String
  containerName        String
  serverDomain         String
  stapeDefaultDomain   String
  stapeDomainId        String?
  dnsRecords           Json?
  status               StapeContainerStatus @default(PENDING)
  domainStatus         StapeDomainStatus    @default(PENDING)
  gtmServerContainerId String?
  gtmServerAccountId   String?
  gtmServerWorkspaceId String?
  tenantId             String
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([tenantId])
  @@index([customerId])
  @@map("stape_containers")
}

model GoogleAdsAccount {
  id              String  @id @default(cuid())
  googleAccountId String
  accountId       String
  accountName     String
  currency        String
  timeZone        String
  isActive        Boolean @default(true)

  // OneClickTag label in this Ads account
  octLabelId String? // Label resource name for "OneClickTag - {User}" label

  // Customer relation
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Tenant relation
  tenantId String

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, tenantId])
  @@index([tenantId, customerId])
  @@map("google_ads_accounts")
}

model GA4Property {
  id               String  @id @default(cuid())
  googleAccountId  String
  propertyId       String // GA4 property ID (e.g., "123456789")
  propertyName     String
  displayName      String?
  websiteUrl       String?
  timeZone         String?
  currency         String?
  industryCategory String?
  isActive         Boolean @default(true)

  // Measurement ID (e.g., "G-XXXXXXXXXX")
  measurementId String?

  // Customer relation
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Tenant relation
  tenantId String

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([propertyId, tenantId])
  @@index([tenantId, customerId])
  @@index([customerId])
  @@map("ga4_properties")
}

model AnalyticsAggregation {
  id                   String   @id @default(cuid())
  tenantId             String
  aggregationType      String // 'DAILY', 'WEEKLY', 'MONTHLY'
  dateRangeStart       DateTime
  dateRangeEnd         DateTime
  metrics              Json // Array of metric names
  dimensions           Json // Array of dimension names
  totalRecords         Int      @default(0)
  processedCustomers   Int      @default(0)
  processedAdsAccounts Int      @default(0)
  generatedAt          DateTime @default(now())
  data                 Json // Aggregated data results

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, aggregationType, dateRangeStart, dateRangeEnd])
  @@index([tenantId, aggregationType])
  @@index([dateRangeStart, dateRangeEnd])
  @@map("analytics_aggregations")
}

model Campaign {
  id                     String  @id @default(cuid())
  name                   String
  type                   String // 'SEARCH', 'DISPLAY', 'SHOPPING', etc.
  status                 String // 'ENABLED', 'PAUSED', 'REMOVED', etc.
  budget                 String // Budget in micros
  biddingStrategy        String?
  advertisingChannelType String?

  // Google Ads specific fields
  googleCampaignId String?
  googleAccountId  String?

  // Customer relation
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Tenant relation
  tenantId String

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([googleCampaignId, tenantId])
  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@map("campaigns")
}

model ConversionAction {
  id            String  @id @default(cuid())
  name          String
  type          String // 'WEBPAGE', 'PHONE_CALL', 'APP_INSTALL', etc.
  status        String // 'ENABLED', 'PAUSED', 'REMOVED', etc.
  category      String? // 'PURCHASE', 'SIGNUP', 'LEAD', etc.
  valueSettings Json? // Value and currency settings

  // Google Ads specific fields
  googleConversionActionId String?
  googleAccountId          String?

  // Customer relation
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Tenant relation
  tenantId String

  // Tracking relation
  trackings Tracking[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([googleConversionActionId, tenantId])
  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@map("conversion_actions")
}

model Tracking {
  id          String         @id @default(cuid())
  name        String
  type        TrackingType
  description String?
  status      TrackingStatus @default(PENDING)

  // Tracking Configuration
  selector       String? // CSS selector (manual or primary auto-detected)
  urlPattern     String? // URL pattern for page-based triggers
  selectorConfig Json? // {selectors: [{selector, confidence, method}], fallbacks: [...]}

  // Type-specific configuration
  config Json? // Flexible config: {scrollPercentage: 75, timeSeconds: 30, value: 99.99, etc.}

  // Destination: where to send this tracking
  destinations TrackingDestination[] @default([GA4]) // Can be GA4, GOOGLE_ADS, or both

  // Google Tag Manager fields
  gtmTriggerId   String?
  gtmTagId       String? // Can be comma-separated if multiple tags (GA4 + Ads)
  gtmTagIdGA4    String? // Dedicated GA4 tag ID
  gtmTagIdAds    String? // Dedicated Google Ads tag ID
  gtmContainerId String?
  gtmWorkspaceId String? // Track which workspace this was created in

  // GA4 Configuration
  ga4EventName  String? // GA4 event name (e.g., "add_to_cart", "purchase")
  ga4Parameters Json? // GA4 event parameters
  ga4PropertyId String? // Which GA4 property to send to

  // Google Ads relation
  conversionActionId String?
  conversionAction   ConversionAction? @relation(fields: [conversionActionId], references: [id])
  adsConversionLabel String? // Google Ads conversion label
  adsConversionValue Decimal?          @db.Decimal(10, 2) // Default conversion value

  // Customer relation
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Tenant relation
  tenantId String

  // Crawler preparation fields
  isAutoCrawled      Boolean @default(false) // Was this created by crawler?
  crawlMetadata      Json? // {detectedAt, pageUrl, elementContext, etc.}
  selectorConfidence Float? // 0-1 confidence score for auto-detected selectors

  // Server-side GTM fields (Stape)
  trackingMode  TrackingMode @default(CLIENT_SIDE)
  sgtmTriggerId String?
  sgtmTagId     String?
  sgtmTagIdAds  String?

  // Error tracking & sync
  lastError    String?
  lastSyncAt   DateTime?
  syncAttempts Int       @default(0)

  // Health verification
  googleHealth      GoogleHealth @default(UNCHECKED)
  lastHealthCheckAt DateTime?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@index([customerId, status])
  @@index([customerId, type])
  @@index([isAutoCrawled])
  @@map("trackings")
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  ARCHIVED
}

enum TrackingType {
  // Basic Interactions
  BUTTON_CLICK
  LINK_CLICK
  PAGE_VIEW
  ELEMENT_VISIBILITY

  // Forms
  FORM_SUBMIT
  FORM_START
  FORM_ABANDON

  // E-commerce
  ADD_TO_CART
  REMOVE_FROM_CART
  ADD_TO_WISHLIST
  VIEW_CART
  CHECKOUT_START
  CHECKOUT_STEP
  PURCHASE
  PRODUCT_VIEW

  // Lead Generation
  PHONE_CALL_CLICK
  EMAIL_CLICK
  DOWNLOAD
  DEMO_REQUEST
  SIGNUP

  // Engagement
  SCROLL_DEPTH
  TIME_ON_PAGE
  VIDEO_PLAY
  VIDEO_COMPLETE

  // Navigation & Search
  SITE_SEARCH
  FILTER_USE
  TAB_SWITCH
  ACCORDION_EXPAND
  MODAL_OPEN

  // Social & Sharing
  SOCIAL_SHARE
  SOCIAL_CLICK

  // Content
  PDF_DOWNLOAD
  FILE_DOWNLOAD
  NEWSLETTER_SIGNUP

  // Custom
  CUSTOM_EVENT

  // Advanced Behavioral
  RAGE_CLICK
  DEAD_CLICK
  TAB_VISIBILITY
  SESSION_DURATION
  EXIT_INTENT
  TEXT_COPY
  PAGE_PRINT
  FORM_FIELD_INTERACTION
  ERROR_PAGE_VIEW
  RETURN_VISITOR
  OUTBOUND_CLICK
  PAGE_ENGAGEMENT

  // Niche-Specific Behavioral
  PRODUCT_IMAGE_INTERACTION
  CART_ABANDONMENT
  PRICE_COMPARISON
  REVIEW_INTERACTION
  CONTENT_READ_THROUGH
}

enum TrackingStatus {
  PENDING // Not yet synced to GTM/GA4/Ads
  CREATING // Currently being created in Google systems
  ACTIVE // Successfully created and active
  FAILED // Creation failed - see lastError
  PAUSED // Temporarily disabled
  SYNCING // Currently syncing updates
}

enum TrackingDestination {
  GA4 // Google Analytics 4 only
  GOOGLE_ADS // Google Ads conversion only
  BOTH // Both GA4 and Google Ads (deprecated - use array)
}

enum StapeContainerStatus {
  PENDING
  PROVISIONING
  ACTIVE
  FAILED
}

enum StapeDomainStatus {
  PENDING
  VALIDATED
  FAILED
}

enum TrackingMode {
  CLIENT_SIDE
  SERVER_SIDE
}

enum GoogleHealth {
  HEALTHY
  MISSING_TRIGGER
  MISSING_TAG
  MISSING_CONVERSION
  WORKSPACE_GONE
  UNCHECKED
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model ContentPage {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  content         String   @db.Text
  metaTitle       String?
  metaDescription String?
  isPublished     Boolean  @default(false)
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  updatedBy       String?

  @@index([slug])
  @@index([isPublished])
  @@map("content_pages")
}

model Plan {
  id            String   @id @default(cuid())
  name          String
  description   String?  @db.Text
  features      Json // Array of feature strings
  price         Decimal  @db.Decimal(10, 2)
  billingPeriod String // 'MONTHLY', 'YEARLY'
  currency      String   @default("USD")
  isActive      Boolean  @default(true)
  isFeatured    Boolean  @default(false)
  order         Int      @default(0)
  ctaText       String   @default("Get Started")
  ctaUrl        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users User[]

  @@index([isActive])
  @@index([order])
  @@map("plans")
}

model LandingPageContent {
  id        String   @id @default(cuid())
  key       String   @unique // 'hero', 'features', 'how-it-works', 'social-proof', 'cta'
  content   Json // Flexible JSON structure for each section
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@map("landing_page_content")
}

model SiteSettings {
  id                String   @id @default(cuid())
  key               String   @unique // 'global' or specific setting key
  logoUrl           String? // URL to logo image
  faviconUrl        String? // URL to favicon
  brandName         String?
  brandColors       Json? // {primary, secondary, accent}
  heroBackgroundUrl String? // URL to hero background image
  metaTitle         String?
  metaDescription   String?
  socialImageUrl    String? // OG image
  customCSS         String?  @db.Text
  customJS          String?  @db.Text
  seoSettings       Json? // Advanced SEO: {googleAnalyticsId, googleTagManagerId, robotsNoIndex, robotsNoFollow, canonicalUrl, twitterCardType, ogType, structuredData}
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@map("site_settings")
}

model ContactPageContent {
  id            String   @id @default(cuid())
  email         String?
  phone         String?
  address       String?
  businessHours String?
  socialLinks   Json? // Array of {platform, url}
  faqs          Json? // Array of {question, answer}
  formSettings  Json? // {enableForm, emailTo, successMessage}
  customContent Json? // Additional custom sections
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedBy     String?

  @@map("contact_page_content")
}

model FooterContent {
  id               String   @id @default(cuid())
  brandName        String?
  brandDescription String?  @db.Text
  socialLinks      Json? // Array of {platform, url, icon}
  sections         Json? // Array of {title, links: [{label, url}]}
  copyrightText    String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  updatedBy        String?

  @@index([isActive])
  @@map("footer_content")
}

// Early Access / Lead Generation Models

model Lead {
  id      String @id @default(cuid())
  name    String
  email   String
  purpose String @db.Text

  // Metadata
  ipAddress   String?
  userAgent   String?
  source      String? // 'landing', 'hero', 'cta'
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Relations
  responses QuestionnaireResponse[]
  pageViews LeadPageView[]
  emailLogs EmailLog[]

  // GDPR Compliance
  acceptedTerms      Boolean   @default(false) // User accepted terms of service
  acceptedTermsAt    DateTime? // When terms were accepted
  marketingConsent   Boolean   @default(false) // User consented to marketing communications
  marketingConsentAt DateTime? // When marketing consent was given

  // Status
  questionnaireCompleted Boolean   @default(false)
  completedAt            DateTime?

  // Email preferences
  unsubscribed      Boolean   @default(false) // User unsubscribed from emails
  unsubscribedAt    DateTime? // When they unsubscribed
  unsubscribeReason String? // Reason for unsubscribing

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email])
  @@index([email])
  @@index([createdAt])
  @@index([questionnaireCompleted])
  @@index([acceptedTerms])
  @@index([unsubscribed])
  @@map("leads")
}

model QuestionnaireQuestion {
  id          String       @id @default(cuid())
  question    String       @db.Text
  type        QuestionType @default(TEXT)
  options     Json? // For radio/checkbox questions: ["Option 1", "Option 2"]
  placeholder String?
  order       Int          @default(0)
  isRequired  Boolean      @default(true)
  isActive    Boolean      @default(true)
  category    String? // 'behavior', 'issues', 'needs', 'demographics'

  // Relations
  responses QuestionnaireResponse[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([isActive, order])
  @@map("questionnaire_questions")
}

model QuestionnaireResponse {
  id         String                @id @default(cuid())
  leadId     String
  lead       Lead                  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  questionId String
  question   QuestionnaireQuestion @relation(fields: [questionId], references: [id])
  answer     Json // Flexible: string, number, array

  createdAt DateTime @default(now())

  @@unique([leadId, questionId])
  @@index([leadId])
  @@map("questionnaire_responses")
}

model LeadPageView {
  id        String   @id @default(cuid())
  leadId    String?
  lead      Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  sessionId String // Anonymous tracking before lead capture
  path      String
  referrer  String?
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("lead_page_views")
}

enum QuestionType {
  TEXT // Short text input
  TEXTAREA // Long text
  RADIO // Single choice
  CHECKBOX // Multiple choice
  RATING // 1-5 stars
  SCALE // 1-10 scale
}

// ========================================
// EMAIL TEMPLATES & TRIGGERS
// ========================================

enum EmailTemplateType {
  QUESTIONNAIRE_THANK_YOU
  LEAD_WELCOME
  CUSTOM
}

// Actions that can trigger emails
enum EmailTriggerAction {
  LEAD_SIGNUP // When a new lead signs up for early access
  QUESTIONNAIRE_COMPLETE // When a lead completes the questionnaire
  // Future actions can be added here:
  // USER_SIGNUP
  // PASSWORD_RESET
  // CUSTOMER_CREATED
}

model EmailTrigger {
  id           String             @id @default(cuid())
  action       EmailTriggerAction @unique
  templateType EmailTemplateType
  isActive     Boolean            @default(true)
  description  String?            @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([action])
  @@index([isActive])
  @@map("email_triggers")
}

model EmailTemplate {
  id                 String            @id @default(cuid())
  type               EmailTemplateType @unique
  name               String
  subject            String
  htmlContent        String            @db.Text
  textContent        String?           @db.Text
  availableVariables Json? // {name: 'Recipient name', email: 'Email'}
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  createdBy          String?
  updatedBy          String?

  @@index([type])
  @@index([isActive])
  @@map("email_templates")
}

model EmailLog {
  id             String            @id @default(cuid())
  templateType   EmailTemplateType
  recipientEmail String
  recipientName  String?
  subject        String
  status         String            @default("PENDING") // PENDING, SENT, FAILED
  errorMessage   String?           @db.Text
  leadId         String?
  lead           Lead?             @relation(fields: [leadId], references: [id], onDelete: SetNull)
  sentAt         DateTime?
  createdAt      DateTime          @default(now())

  @@index([recipientEmail])
  @@index([status])
  @@index([leadId])
  @@index([createdAt])
  @@map("email_logs")
}

// ========================================
// COMPLIANCE MODELS
// ========================================

model ComplianceSettings {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Company Information
  companyName    String
  companyAddress String  @db.Text
  companyPhone   String?
  companyEmail   String

  // DPO (Data Protection Officer) Information
  dpoName  String?
  dpoEmail String?
  dpoPhone String?

  // CCPA Information
  ccpaTollFreeNumber String?

  // Contact Emails
  apiContactEmail     String? // For Google API communications
  privacyContactEmail String? // For privacy inquiries

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([tenantId])
  @@index([tenantId])
  @@map("compliance_settings")
}

enum CookieConsentCategory {
  NECESSARY
  ANALYTICS
  MARKETING
}

model CookieCategory {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  category    CookieConsentCategory
  name        String // "Strictly Necessary", "Analytics & Performance", "Marketing"
  description String                @db.Text
  isRequired  Boolean               @default(false) // NECESSARY is always required

  cookies Cookie[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, category])
  @@index([tenantId])
  @@map("cookie_categories")
}

model Cookie {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  categoryId String
  category   CookieCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  name     String // "_ga"
  provider String // "Google Analytics"
  purpose  String @db.Text
  duration String // "2 years", "Session", "13 months"
  type     String @default("HTTP") // HTTP, JavaScript, Pixel

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([categoryId])
  @@map("cookies")
}

model CookieConsentBanner {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Banner Text
  headingText         String @default("We value your privacy")
  bodyText            String @default("We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic. By clicking 'Accept All', you consent to our use of cookies.") @db.Text
  acceptAllButtonText String @default("Accept All")
  rejectAllButtonText String @default("Reject All")
  customizeButtonText String @default("Customize")
  savePreferencesText String @default("Save Preferences")

  // Banner Styling
  position             String @default("bottom") // bottom, top
  backgroundColor      String @default("#ffffff")
  textColor            String @default("#000000")
  acceptButtonColor    String @default("#10b981")
  rejectButtonColor    String @default("#ef4444")
  customizeButtonColor String @default("#6b7280")

  // Behavior
  consentExpiryDays        Int     @default(365) // GDPR recommends 13 months max
  showOnEveryPage          Boolean @default(true)
  blockCookiesUntilConsent Boolean @default(true)

  // Links
  privacyPolicyUrl String @default("/privacy")
  cookiePolicyUrl  String @default("/cookie-policy")

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId])
  @@index([tenantId])
  @@map("cookie_consent_banners")
}

model UserCookieConsent {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String? // Null for anonymous users
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  anonymousId String? // UUID for anonymous users (stored in localStorage)

  // Consent Choices
  necessaryCookies Boolean @default(true) // Always true (can't be disabled)
  analyticsCookies Boolean @default(false)
  marketingCookies Boolean @default(false)

  // Metadata
  consentGivenAt   DateTime @default(now())
  consentExpiresAt DateTime // Calculated based on consentExpiryDays
  ipAddress        String?
  userAgent        String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([anonymousId])
  @@index([consentExpiresAt])
  @@map("user_cookie_consents")
}

enum DataRequestType {
  ACCESS // GDPR Art. 15 - Right to access
  RECTIFICATION // GDPR Art. 16 - Right to rectification
  ERASURE // GDPR Art. 17 - Right to erasure ("right to be forgotten")
  PORTABILITY // GDPR Art. 20 - Right to data portability
  RESTRICTION // GDPR Art. 18 - Right to restriction of processing
  OBJECTION // GDPR Art. 21 - Right to object
  CCPA_DELETE // CCPA - Right to deletion
  CCPA_ACCESS // CCPA - Right to know
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

model DataAccessRequest {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Request Details
  requestType DataRequestType
  email       String // Email of requester (may not match userId if request via email)
  description String?         @db.Text
  status      RequestStatus   @default(PENDING)

  // Response
  responseMessage String? @db.Text
  dataExportUrl   String? // S3/storage URL for data export

  // Deadlines (GDPR: 1 month, extendable to 3 months)
  requestedAt DateTime  @default(now())
  dueDate     DateTime // Auto-calculated: requestedAt + 30 days
  completedAt DateTime?

  // Audit
  assignedTo     String? // Admin user ID
  assignedToUser User?   @relation("AssignedRequests", fields: [assignedTo], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([tenantId, status])
  @@index([dueDate])
  @@map("data_access_requests")
}

model ApiAuditLog {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // API Call Details
  apiService String // "Google Ads API", "GTM API", "GA4 API"
  endpoint   String // "/tagmanager/v2/accounts/-/containers/123/workspaces/456/tags"
  httpMethod String // GET, POST, PUT, DELETE

  // Request/Response
  requestPayload Json? // Request body (sanitized - no tokens)
  responseStatus Int // 200, 400, 401, etc.
  responseBody   Json? // Response (sanitized)
  errorMessage   String? @db.Text

  // Performance
  durationMs Int? // Request duration in milliseconds

  // Metadata
  ipAddress String?
  userAgent String? @db.Text

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([customerId])
  @@index([apiService])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([customerId, createdAt])
  @@map("api_audit_logs")
}

model SubProcessor {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name             String // "Google LLC"
  purpose          String  @db.Text // "Cloud infrastructure and data processing"
  dataShared       String  @db.Text // "User email, OAuth tokens, tracking data"
  location         String // "United States"
  dpaUrl           String? // Link to their DPA
  privacyPolicyUrl String? // Link to their privacy policy

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("sub_processors")
}

model PrivacyPolicySection {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  key      String // "data-collection", "gdpr-rights", "ccpa-rights", etc.
  title    String
  content  String  @db.Text
  order    Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, key])
  @@unique([tenantId, order])
  @@index([tenantId])
  @@map("privacy_policy_sections")
}

// ========================================
// SITE CREDENTIALS (for authenticated crawling)
// ========================================

model SiteCredential {
  id         String   @id @default(cuid())
  customerId String
  tenantId   String
  domain     String
  username   String // encrypted
  password   String // encrypted
  loginUrl   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, domain, tenantId])
  @@index([tenantId])
  @@map("site_credentials")
}

// ========================================
// SEO & SITEMAP MANAGEMENT
// ========================================

model PageSeoSettings {
  id       String @id @default(cuid())
  pageSlug String @unique // e.g., "/", "/early-access", "/content/about"

  // Meta overrides
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  // Robots directives
  noIndex  Boolean @default(false)
  noFollow Boolean @default(false)

  // Structured data for this specific page
  structuredData String? @db.Text

  // Sitemap settings
  sitemapPriority    Float   @default(0.5)
  sitemapFreq        String  @default("monthly") // daily, weekly, monthly, yearly
  excludeFromSitemap Boolean @default(false)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([pageSlug])
  @@index([excludeFromSitemap])
  @@map("page_seo_settings")
}

// ========================================
// SITE SCANNER / AUTOTRACK
// ========================================

enum SiteScanStatus {
  QUEUED
  DISCOVERING
  CRAWLING
  NICHE_DETECTED
  AWAITING_CONFIRMATION
  AWAITING_AUTH
  DEEP_CRAWLING
  ANALYZING
  COMPLETED
  FAILED
  CANCELLED
}

enum RecommendationSeverity {
  CRITICAL
  IMPORTANT
  RECOMMENDED
  OPTIONAL
}

enum RecommendationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CREATING
  CREATED
  FAILED
  REPAIR
}

enum QueueJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
  PAUSED
}

enum BatchStatus {
  PROCESSING
  COMPLETED
  PAUSED
  CANCELLED
}

model SiteScan {
  id         String         @id @default(cuid())
  customerId String
  customer   Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tenantId   String
  status     SiteScanStatus @default(QUEUED)

  // Scan configuration
  websiteUrl String
  maxPages   Int    @default(50)
  maxDepth   Int    @default(3)

  // Phase 1 results: Niche detection
  detectedNiche    String?
  nicheConfidence  Float?
  nicheSignals     Json?
  nicheSubCategory String?
  confirmedNiche   String?

  // Technology detection
  detectedTechnologies Json?
  existingTracking     Json?

  // Phase 2 results
  totalPagesScanned      Int?
  totalRecommendations   Int?
  trackingReadinessScore Int?
  readinessNarrative     String? @db.Text
  recommendationCounts   Json?

  // Site map
  siteMap Json?

  // Live discovery state (accumulated during chunked processing)
  liveDiscovery  Json?
  totalUrlsFound Int   @default(0)
  urlQueue       Json? // [{url, depth, source}]
  crawledUrls    Json? // URLs already crawled (array)

  // Login detection
  loginDetected Boolean @default(false)
  loginUrl      String?
  credentialId  String?

  // Job tracking
  jobId        String?
  errorMessage String? @db.Text

  // AI usage tracking
  aiAnalysisUsed Boolean @default(false)

  // V2: Deep Explorer
  authenticatedPagesCount Int   @default(0)
  obstaclesDismissed      Int   @default(0)
  totalInteractions       Int   @default(0)
  sessionCookies          Json?

  // Relations
  pages           ScanPage[]
  recommendations TrackingRecommendation[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@index([customerId, createdAt])
  @@index([customerId, tenantId, status])
  @@map("site_scans")
}

model ScanPage {
  id     String   @id @default(cuid())
  scanId String
  scan   SiteScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  url      String
  title    String?
  depth    Int     @default(0)
  pageType String?

  hasForm         Boolean @default(false)
  hasCTA          Boolean @default(false)
  hasVideo        Boolean @default(false)
  hasPhoneLink    Boolean @default(false)
  hasEmailLink    Boolean @default(false)
  hasDownloadLink Boolean @default(false)

  importanceScore         Float?
  metaTags                Json?
  headings                Json?
  contentSummary          String? @db.Text
  isAuthenticated         Boolean @default(false)
  templateGroup           String?
  scrollableHeight        Int?
  interactiveElementCount Int?
  obstaclesEncountered    Json?

  createdAt DateTime @default(now())

  @@index([scanId])
  @@index([scanId, pageType])
  @@map("scan_pages")
}

model TrackingRecommendation {
  id     String   @id @default(cuid())
  scanId String
  scan   SiteScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  name         String
  description  String?      @db.Text
  trackingType TrackingType

  severity       RecommendationSeverity @default(RECOMMENDED)
  severityReason String?                @db.Text

  selector           String?
  selectorConfig     Json?
  selectorConfidence Float?

  urlPattern  String?
  pageUrl     String?
  funnelStage String?

  elementContext Json?

  suggestedConfig       Json?
  suggestedGA4EventName String?
  suggestedDestinations Json?

  status     RecommendationStatus @default(PENDING)
  trackingId String?

  aiGenerated         Boolean @default(false)
  businessValue       String? @db.Text
  implementationNotes String? @db.Text
  affectedRoutes      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scanId])
  @@index([scanId, severity])
  @@index([scanId, status])
  @@map("tracking_recommendations")
}

model TrackingBatch {
  id         String      @id @default(cuid())
  scanId     String
  customerId String
  tenantId   String
  userId     String

  status      BatchStatus @default(PROCESSING)
  totalJobs   Int         @default(0)
  completed   Int         @default(0)
  failed      Int         @default(0)

  pausedAt    DateTime?
  resumeAfter DateTime?
  pauseReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobs TrackingQueueJob[]

  @@index([tenantId, status])
  @@index([customerId])
  @@index([status, resumeAfter])
  @@map("tracking_batches")
}

model TrackingQueueJob {
  id      String        @id @default(cuid())
  batchId String
  batch   TrackingBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  trackingId       String
  recommendationId String

  status      QueueJobStatus @default(QUEUED)
  step        String? // 'ads_sync' | 'gtm_sync'

  attempts    Int      @default(0)
  maxAttempts Int      @default(5)
  nextRetryAt DateTime?
  lastError   String?  @db.Text
  errorCode   String?

  priority Int @default(0)

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([batchId, status])
  @@index([status, nextRetryAt])
  @@index([status, priority, createdAt])
  @@map("tracking_queue_jobs")
}
